sap.ui.define(["jquery.sap.global","sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/model/json/JSONModel","victoria/dbapi/dbapi","sap/m/MessageBox","sap/m/MessagePopover","sap/m/MessageToast","sap/m/MessageItem","victoria/models/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,r,s,i,a,o,l,n,d,g,u){"use strict";var p;var c;var h;var m;var f;return t.extend("victoria.controller.BaseController",{formatter:d,ODataHelper:i,MessageBox:a,MessageToast:l,onInit:function(){var e=this;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/AppUsers","GET",null,null,this).then(function(t){for(var r=0;r<t.results.length;r++){e.allMasterData.users[t.results[r].TechnicalId]=t.results[r]}}).catch(function(t){var r=e.getErrorMessage(t)});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/api/Entrys","POST",null,oPayload,this).then(function(t){for(var r=0;r<t.results.length;r++){e.allMasterData.users[t.results[r].TechnicalId]=t.results[r]}}).catch(function(t){var r=e.getErrorMessage(t)});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/api/Entrys","PATCH",null,oPayload,this).then(function(t){for(var r=0;r<t.results.length;r++){e.allMasterData.users[t.results[r].TechnicalId]=t.results[r]}}).catch(function(t){var r=e.getErrorMessage(t)})},getRouter:function(){return this.getOwnerComponent().getRouter()},getCurrentUser:function(){return this.currentUser},getCustomerPopup:function(e){if(!this.searchPopup){var t=this;this.searchPopup=new sap.ui.xmlfragment("victoria.fragments.popup",this);this.getView().addDependent(this.searchPopup);var r=this.getView().getModel("i18n").getProperty("customer");this.searchPopup.setTitle(r);this.searchPopup.bindAggregation("items",{path:"/Customers",template:new sap.m.DisplayListItem({label:"{CustomerCode}",value:{parts:[{path:"Name"},{path:"City"}],formatter:function(e,r){return e+"-"+t.allMasterData.cities[r].cityName}}}),sorter:new sap.ui.model.Sorter("CustomerCode")})}this.searchPopup.open()},onSearch:function(e){var t=e.getParameter("value");r=[];if(!t){t=e.getParameter("newValue")}if(t){var r=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,t.toUpperCase()),new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t.toUpperCase())],and:false})}this.searchPopup.getBinding("items").filter(r)},getKachhiCustPopup:function(e){if(!this.kCustomersearchPopup){this.kCustomersearchPopup=new sap.ui.xmlfragment("victoria.fragments.popup",this);this.getView().addDependent(this.kCustomersearchPopup);var t=this.getView().getModel("i18n").getProperty("customer");this.kCustomersearchPopup.setTitle(t);var r=new sap.ui.model.Filter("Type",sap.ui.model.FilterOperator.EQ,"Kata Center");this.kCustomersearchPopup.bindAggregation("items",{path:"/Customers",filters:[r],template:new sap.m.DisplayListItem({label:"{CustomerCode}",value:"{Name} - {city}"})})}this.kCustomersearchPopup.open()},getDialogPopup:function(){if(!this.oDialogPopup){this.oDialogPopup=new sap.ui.xmlfragment("idDialog","victoria.fragments.Dialog",this);this.getView().addDependent(this.oDialogPopup)}this.oDialogPopup.open()},getQuery:function(e){var t=e.getParameter("query");if(!t){t=e.getParameter("value")}return t},getSelectedKey:function(e,t,r){var t=e.getParameter("selectedItem").getValue();var r=e.getParameter("selectedItem").getLabel();var s=e.getParameter("selectedItem").getBindingContextPath();var i=this.getView().getModel().getProperty(s).id;return[t,r,i]},getObjListSelectedkey:function(e){var t=e.getParameter("selectedItem").getTitle();var r=e.getParameter("selectedItem").getIntro();var s=e.getParameter("selectedItem").getNumber();var i=e.getParameter("selectedItem").getBindingContextPath();var a=this.getView().getModel().getProperty(i).id;return[t,r,s,a]},getModel:function(e){return this.getOwnerComponent().getModel(e)},messagePoper:null,createMessagePopover:function(){var e=this;if(!this.messagePoper){this.messagePoper=sap.ui.xmlfragment("victoria.fragments.DependencyChecker",this);this.getView().addDependent(this.messagePoper);this.messagePoper.setModel(this.getOwnerComponent().getModel("local"),"local")}this.messagePoper.open()},toggleUiTable:function(e,t){if(this.toggleTableState===true){this._openFullScreen(e,t);this.toggleTableState=false;this.byId(e).setTooltip("exit fullScreen")}else{this._closeFullScreen(e,t);this.toggleTableState=true;this.byId(e).setTooltip("fullScreen")}var r=this.toggleTableState?"sap-icon://full-screen":"sap-icon://exit-full-screen";this.byId(e).setIcon(r)},_closeFullScreen:function(e,t){this.getView().byId(t).setVisible(true);this.getView().oParent.oParent._oMasterNav.setVisible(true)},_openFullScreen:function(e,t){this.getView().byId(t).setVisible(false);this.getView().oParent.oParent._oMasterNav.setVisible(false)},destroyMessagePopover:function(){if(this.messagePoper){this.messagePoper.destroy();this.messagePoper=null}},getErrorMessage:function(e){var t=[];var r;var s;if(e.statusText=="Unauthorized"){this.redirectLoginPage()}try{var t=e.responseText.split(".")[1];if(e.responseText.split(".")["length"]>2){t=e.responseText}if(!t){t=e.responseText.split(":")[1]}}catch(r){if(e.message){t=";"+e.message}else{return e.responseText.split(".")[1]}}t=t.split(";");var i=[];for(var a=0;a<t.length;a++){i.push({type:"Error",description:t[a]})}if(i){this.getOwnerComponent().getModel("local").setProperty("/messages",i);this.getOwnerComponent().getModel("local").setProperty("/messagesLength",i.length);this.createMessagePopover()}},handlevalidationDialogClose:function(){this.messagePoper.close();if(this.messagePoper){this.messagePoper.destroy();this.messagePoper=null}},handleGoldValidation:function(e){var t=parseFloat(e,10);if((t<3e4||t>8e4)&&t>0){var r=false;return r}else{var r=true;return r}},handleSilverValidation:function(e){var t=parseFloat(e,10);if((t<3e4||t>11e4)&&t>0){var r=false;return r}else{var r=true;return r}},setModel:function(e,t){return this.getView().setModel(e,t)},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle()},redirectLoginPage:function(e,t){var r=this;var s=r.getView().getModel().getHeaders().Authorization;if(e=="X"&&t!="X"){a.alert("Logout Successful")}else if(t!="X"){a.alert(r.resourceBundle.getText("Page11"))}window.top.location.href="/"},onNavBack:function(){var e=r.getInstance().getPreviousHash(),t=sap.ushell.Container.getService("CrossApplicationNavigation");if(e!==undefined||!t.isInitialNavigation()){history.go(-1)}else{this.getRouter().navTo("master",{},true)}},getEventBus:function(){return sap.ui.getCore().getEventBus()},getViewModel:function(){return new s({busy:false,delay:0,mode:"view",oldRec:"false",extendedMode:false})},clearData:function(){},onSwitchStateChange:function(e){},onAutoLoginCheck:function(e){},onDateFormatted:function(e){var t=e.getDate();var r=e.getMonth()+1;var s=e.getFullYear();if(t<10){t="0"+t}if(r<10){r="0"+r}return t+"."+r+"."+s},copyTextToClipboard:function(e){if(!navigator.clipboard){fallbackCopyTextToClipboard(e);return}navigator.clipboard.writeText(e).then(function(){console.log("Async: Copying to clipboard was successful!")},function(e){console.error("Async: Could not copy text: ",e)})},fallbackCopyTextToClipboard:function(e){var t=document.createElement("textarea");t.value=e;document.body.appendChild(t);t.focus();t.select();try{var r=document.execCommand("copy");var s=r?"successful":"unsuccessful";console.log("Fallback: Copying text command was "+s)}catch(e){console.error("Fallback: Oops, unable to copy",e)}document.body.removeChild(t)},onSystemHelp:function(e){},mapFieldsFromBaseToItem:function(e){var t=this.getView().getModel("local").getProperty("orderItemBase");if(e==="R"){}else{}},setVisible:function(e,t){var r=new sap.ui.model.json.JSONModel({rows1:true});this.setModel(r,"visModel");if(t){var s=this.getView().getModel("visModel");s.setProperty("/rows1",false)}else if(e.getParameter("name")==="sales"){var s=this.getView().getModel("visModel");s.setProperty("/rows1",false)}else if(e.getParameter("name")==="salesws"){var s=this.getView().getModel("visModel");s.setProperty("/rows1",true)}else if(e.getParameter("id")){if(e.getParameter("id").split("---")[1]==="idsales"){var s=this.getView().getModel("visModel");s.setProperty("/rows1",false)}else if(e.getParameter("id").split("---")[1].split("--")[0]==="idsales"){var s=this.getView().getModel("visModel");s.setProperty("/rows1",false)}}else if(e.getSource().getContent().getId()==="idsales"){var s=this.getView().getModel("visModel");s.setProperty("/rows1",false)}else if(e.getSource().getContent().getId()==="sales-page"){var s=this.getView().getModel("visModel");s.setProperty("/rows1",false)}},focusAndSelectNextInput:function(e,t){setTimeout(function(){var r=$(t);var s=r.toArray().filter(t=>t.id.includes(e));var i=r.index(s[0]);if(r[i+1]!=null){var a=r[i+1];a.focus();a.select()}},300)},ValueChangeMaterial:function(e){var t=e.getSource().getId().split("---")[1];if(t!==undefined){if(t.split("--")[0]==="idsales"){this.byId("Sales--idSaveIcon").setColor("red")}}var r=sap.ui.core.Fragment.byId("fr1","idSaveIndicator");if(r){r.setColor("red")}$(function(){$("input:text:first").focus();var e=$("input:text");e.bind("keypress",function(t){var r=t.which;if(r==13){t.preventDefault();var s=e.index(this)+1;$(":input:text:eq("+s+")").focus()}})});var s=this;var i=e.getSource().getParent().getBindingContext("orderItems");var a=this.getView().getModel("local").getProperty("/orderHeader");var o=null;if(!i){i=e.getSource().getParent().getBindingContext("materialPopupOrderItems");o=a.id;var l=e.getSource().mBindingInfos.value.binding.oContext.sPath;if(!o){var n=new sap.ui.model.Filter("OrderNo","EQ",a.OrderNo);s.ODataHelper.callOData(s.getOwnerComponent().getModel(),"/OrderHeaders","GET",{filters:[n]},{},s).then(function(e){o=e.results[e.results.length-1].id;l=l+"/OrderNo";s.getView().getModel("materialPopupOrderItems").setProperty(l,o)})}else{l=l+"/OrderNo";s.getView().getModel("materialPopupOrderItems").setProperty(l,o)}}var d=i.getModel("local");var g=e.getSource().getParent().getBindingContext("orderItems");if(!g){g=e.getSource().getParent().getBindingContext("materialPopupOrderItems")}var u=g.getPath();var p=d.getProperty(u+"/MaterialCode");var c=e.getSource().getId();var n=new sap.ui.model.Filter("ProductCode","EQ",p.toUpperCase());this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Products","GET",{filters:[n]},{},this).then(function(e){console.log(e.results[0]);if(e.results[0]){if(c.includes("fr1")){s.focusAndSelectNextInput(c,"input[id*='fr1--id']")}else{s.focusAndSelectNextInput(c,"input[id*='---idsales--']")}}d.setProperty(u+"/Material",e.results[0].id);if(e.results[0].HindiName){d.setProperty(u+"/Description",e.results[0].HindiName)}else{d.setProperty(u+"/Description",e.results[0].ProductName)}d.setProperty(u+"/MaterialCode",e.results[0].ProductCode);if(e.results[0].Making){d.setProperty(u+"/Making",e.results[0].CustomerMaking?e.results[0].CustomerMaking:e.results[0].Making)}if(e.results[0].PricePerUnit){d.setProperty(u+"/MakingD",e.results[0].PricePerUnit)}if(e.results[0].Tunch){d.setProperty(u+"/Tunch",e.results[0].CustomerTunch?e.results[0].CustomerTunch:e.results[0].Tunch)}d.setProperty(u+"/Category",e.results[0].Category);d.setProperty(u+"/Type",e.results[0].Type);d.setProperty(u+"/Karat",e.results[0].Karat)}).catch(function(e){})},materialPopup:null,onFindMaterial:function(){var e=this;var t=this.getView().getModel("local").getProperty("/orderHeader");if(t.OrderNo!==0&&t.OrderNo!==""){if(!this.materialPopup){this.materialPopup=new sap.ui.xmlfragment("fr1","victoria.fragments.tableSelectDialog",this);this.getView().addDependent(this.materialPopup)}e.clearPopupScreen();var r=r=t.id;var s=null;if(!r){var s=new sap.ui.model.Filter("OrderNo","EQ",t.OrderNo);e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/OrderHeaders","GET",{filters:[s]},{},e).then(function(t){r=t.results[t.results.length-1].id;r="'"+r+"'";s=new sap.ui.model.Filter("OrderNo","EQ",r);e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/StockItems","GET",{filters:[s]},{},e).then(function(t){if(t.results.length>0){var r=e.getView().getModel("materialPopupOrderItems").getProperty("/popupItemsData");for(var s=0;s<t.results.length;s++){var i=e.allMasterData.materials[t.results[s].Material];r[s].MaterialCode=i.ProductCode;r[s].Qty=Math.abs(t.results[s].Qty);r[s].id=t.results[s].id;r[s].Description=i.HindiName||i.ProductName;r[s].OrderNo=t.results[s].OrderNo}e.getView().getModel("materialPopupOrderItems").setProperty("/popupItemsData",r)}var a=sap.ui.core.Fragment.byId("fr1","idSaveIndicator");if(a){a.setColor("green")}});setTimeout(function(){$("input[type='Number']").focus(function(){$(this).select()})},300);e.materialPopup.open()})}else{r="'"+r+"'";s=new sap.ui.model.Filter("OrderNo","EQ",r);e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/StockItems","GET",{filters:[s]},{},e).then(function(t){if(t.results.length>0){var r=e.getView().getModel("materialPopupOrderItems").getProperty("/popupItemsData");for(var s=0;s<t.results.length;s++){var i=e.allMasterData.materials[t.results[s].Material];r[s].MaterialCode=i.ProductCode;r[s].Qty=Math.abs(t.results[s].Qty);r[s].id=t.results[s].id;r[s].Description=i.HindiName||i.ProductName;r[s].OrderNo=t.results[s].OrderNo}e.getView().getModel("materialPopupOrderItems").setProperty("/popupItemsData",r)}var a=sap.ui.core.Fragment.byId("fr1","idSaveIndicator");if(a){a.setColor("green")}});setTimeout(function(){$("input[type='Number']").focus(function(){$(this).select()})},300);e.materialPopup.open()}}else{var i=e.getView().getModel("i18n").getResourceBundle().getText("orderValidation");a.show(i,{icon:a.Icon.ERROR,title:"Error",actions:[a.Action.OK],onClose:function(e){}})}},clearPopupScreen:function(){var e=this.getView().getModel("materialPopupOrderItems").getProperty("/popupItemsData");for(var t=0;t<e.length;t++){e[t].MaterialCode="";e[t].Qty="0";e[t].id="";e[t].Description="";e[t].OrderNo=""}this.getView().getModel("materialPopupOrderItems").setProperty("/popupItemsData",e)},onDialogClose:function(e){this.materialPopup.close()},validateValue:function(e){var t=sap.ui.core.Fragment.byId("fr1","dialogSave");if(!t){t=sap.ui.core.Fragment.byId("fr2","dialogSave")}if(e.getSource().getValue()<=0){e.getSource().setValueState(sap.ui.core.ValueState.Error);t.setEnabled(false)}else{e.getSource().setValueState(sap.ui.core.ValueState.None);t.setEnabled(true)}},onDialogSave:function(e){var t=this;var r=sap.ui.core.Fragment.byId("fr1","materialPopupTable");if(!r){r=sap.ui.core.Fragment.byId("fr2","materialPopupTable")}var s=r.getBinding("rows");var i=[];var a=t.getView().getModel("materialPopupOrderItems").getProperty("/popupItemsData");var o=false;var l=sap.ui.core.Fragment.byId("fr1","idSaveIndicator");if(!l){l=sap.ui.core.Fragment.byId("fr2","idSaveIndicator")}for(let e=0;e<s.getLength();e++){var t=this;var n=s.oList[e];if(n.id===""){if(n.MaterialCode!==""){if(l){l.setColor("red")}if(n.Qty>0){}else{o=true;break}}}}if(o===true){sap.m.MessageBox.error("Can't Save! Quantity should be greater than 0");e.getSource().setEnabled(false)}else{for(let e=0;e<s.getLength();e++){var t=this;var n=s.oList[e];if(n.id===""){if(n.MaterialCode!==""){if(n.Qty>0){var d={data:n};d.Date=this.getView().getModel("local").getProperty("/orderHeader/Date");d.Qty=Math.abs(d.Qty)*-1;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/StockItems","POST",{},d,this).then(function(r){t.getView().setBusy(false);a[e].id=r.id;sap.m.MessageToast.show("Data Saved Successfully");if(l){l.setColor("green")}t.getView().getModel("materialPopupOrderItems").setProperty("/popupItemsData",a)}).catch(function(e){t.getView().setBusy(false);var r=t.getErrorMessage(e)})}}}}}},deleteReturnValues:function(e,t,r,s,i){var a=this;var o=a.getView().getModel("returnModel").getProperty("/TransData")[r].ReturnId;if(o){if(s==="idsales"){a.ODataHelper.callOData(a.getOwnerComponent().getModel(),"/OrderReturns('"+o+"')","DELETE",{},{},a)}else{a.ODataHelper.callOData(a.getOwnerComponent().getModel(),"/WSOrderReturns('"+o+"')","DELETE",{},{},a)}sap.m.MessageToast.show("Data Deleted Successfully")}a.deleteReturn(e,r);var i=a.getView().getModel("returnModel").getProperty("/TransData");i.splice(r,1);i.push({Type:"",Key:"",ReturnId:"",Weight:0,KWeight:0,Tunch:0,Qty:0,Bhav:0,Remarks:"",SubTotalS:0,SubTotalG:0,SubTotal:"",CreatedBy:"",CreatedOn:"",ChangedBy:"",ChangedOn:""});a.getView().getModel("returnModel").setProperty("/TransData",i)},onReturnValue:function(e){if(e.getSource().getId().split("---")[1].split("--")[0]=="idsales"){this.byId("Sales--idSaveIcon").setColor("red")}else if(e.getSource().getId().split("---")[1].split("--")[0]=="idsalesws"){this.byId("WSHeaderFragment--idSaveIcon").setColor("red")}var t=this.getView().byId("OrderReturn").getModel("returnModel").getProperty(e.getSource().getParent().getBindingContext("returnModel").getPath());var r=this.getView().getModel("local").getProperty("/CustomCalculations");var s=e.getParameter("selectedItem").getKey();this.defaultValuesLoad(e,t,r,s)},defaultValuesLoad:function(e,t,r,s){var i=this;var a=e.getSource().getParent().getId().split("---")[1].split("--")[0];if(s){t.Key=s}t.Weight="0";t.Tunch="0";t.KWeight="0";t.Quantity="0";t.Remarks="";t.Bhav="0";t.SubTotal="0";if(s==="OG"){t.Tunch="100";if(a==="idsales"){t.Bhav=r.results[0].GoldReturns}else{t.Bhav=r.results[0].GoldReturns1}}else if(s==="BG"){t.Tunch="100";if(a==="idsales"){t.Bhav=r.results[0].GoldReturns}}else if(s==="BS"){t.Tunch="100";if(a==="idsales"){t.Bhav=r.results[0].SilverReturns}}else if(s==="OS"){t.Tunch="100";if(a==="idsales"){t.Bhav=r.results[0].SilverReturns}else{t.Bhav=r.results[0].SilverReturns1}}else if(s==="KG"){if(a==="idsales"){t.Bhav=r.results[0].GoldReturns}}else if(s==="KS"){if(a==="idsales"){t.Bhav=r.results[0].SilverReturns}}else if(s==="CASH"){}i.getView().getModel("local").setProperty("/returnModel",t)},onReturnChange:function(e){if(e.getSource().getId().split("---")[1].split("--")[0]=="idsales"){this.byId("Sales--idSaveIcon").setColor("red");var t=this.getView().getModel("local").getProperty("/orderHeaderTemp");if(this.orderAmount===""){this.orderAmount=t.TotalOrderValue}}else if(e.getSource().getId().split("---")[1].split("--")[0]=="idsalesws"){this.byId("WSHeaderFragment--idSaveIcon").setColor("red")}var r=e.getSource().getParent().getBindingContext("returnModel").getPath();var s=this.getView().getModel("returnModel").getProperty(r);var i=e.getSource().getId().split("---")[1].split("--")[0];if(i==="idsales"){var a=this.getView().getModel("local").getProperty("/orderHeader")}else{}this.returnCalculation(e,a,s);this.finalBal=this.orderAmount-this.deduction;if(this.finalBal===0){var o=0}else{var o=this.getIndianCurr(this.finalBal)}this.getView().getModel("local").setProperty("/orderHeaderTemp/FinalBalance",o)},setReturnNewValue:function(e,t,r){if(t==="IdWeightR"){if(e.Weight!==r){e.Weight=r}}if(t==="IdKWeightR"){if(e.KWeight!==r){e.KWeight=r}}if(t==="IdTunchR"){if(e.Tunch!==r){e.Tunch=r}}if(t==="IdBhavR"){if(e.Bhav!==r){e.Bhav=r}}},getReturnFloatValue:function(e,t){if(e.Weight===""){var r=0;e.Weight=0}else if(e.Weight===0){var r=0;e.Weight=0}else{var r=e.Weight.toString();e.Weight=t.parse(r)}if(e.KWeight===""){var s=0;e.KWeight=0}else if(e.KWeight===0){var s=0;e.KWeight=0}else{var s=e.KWeight.toString();e.KWeight=t.parse(s)}if(e.Tunch===""){var i=0;e.Tunch=0}else if(e.Tunch===0){var i=0;e.Tunch=0}else{var i=e.Tunch.toString();e.Tunch=t.parse(i)}if(e.Bhav===""){var a=0;e.Bhav=0}else if(e.Bhav===0){var a=0;e.Bhav=0}else{var a=e.Bhav.toString();e.Bhav=t.parse(a)}},returnCalculation:function(e,t,r){if(e.getId()==="orderReload"){var s=this.getView().getModel("returnModel").getProperty(r);var i=r;var a=this.getView().byId("OrderReturn")._getVisibleColumns();n=e.viewId}else{var s=r;var o=e.getParameters().newValue;var l=e.getParameters().id.split("---")[1].split("--")[1].split("-")[0];var n=e.getSource().getId().split("---")[1].split("--")[0];var d=e.getSource().getParent();var a=d.getCells()}var g=new sap.ui.core.Locale("en-US");var u=sap.ui.core.format.NumberFormat.getFloatInstance(g);if(o){this.setReturnNewValue(s,l,o)}this.getReturnFloatValue(s,u);if(s.Key==="OG"||s.Key==="KG"||s.Key==="BG"){if(s.Key==="BG"){s.Tunch=100}var p=s.Bhav/10;var c=s.Weight-s.KWeight;var h=s.Tunch*c/100;var m=parseFloat(h).toFixed(3);var f=h*p;var v=parseFloat(f).toFixed(0);v=this.getIndianCurr(v);var y=this.getIndianCurr(f);if(s.SubTotal&&s.SubTotal!==""){var P=u.parse(s.SubTotal);this.deduction=f+this.deduction-P}else{this.deduction=f+this.deduction}var C=this.deduction;var T=this.getIndianCurr(C);if(i){s.SubTotal=y;if(n=="idsalesws"){s.SubTotal=v;if(f){s.SubTotalG=0;s.SubTotalS=0}else{s.SubTotal=0;s.SubTotalG=m;s.SubTotalS=0}}else{if(T==="0"||T===""){T="0"}this.getView().getModel("local").setProperty("/orderHeaderTemp/Deduction",T)}this.getView().byId("OrderReturn").getModel("returnModel").setProperty(i,s)}else{a[a.length-1].setText(y);if(n=="idsalesws"){a[a.length-1].setText(v);if(y){a[a.length-2].setText(0)}else{a[a.length-2].setText(m);a[a.length-3].setText(0)}}else{if(T==="0"||T===""){T="0"}this.getView().getModel("local").setProperty("/orderHeaderTemp/Deduction",T)}}}else if(s.Key==="OS"||s.Key==="KS"||s.Key==="BS"){if(s.Key==="BS"){s.Tunch=100}var p=s.Bhav/1e3;var c=s.Weight-s.KWeight;var w=s.Tunch*c/100;var I=parseFloat(w).toFixed(2);var f=w*p;var v=parseFloat(f).toFixed(0);v=this.getIndianCurr(v);var y=this.getIndianCurr(f);if(s.SubTotal&&s.SubTotal!==""){var P=u.parse(s.SubTotal);this.deduction=f+this.deduction-P}else{this.deduction=f+this.deduction}var C=this.deduction;var T=this.getIndianCurr(C);if(i){s.SubTotal=y;if(n=="idsalesws"){s.SubTotal=v;if(f){s.SubTotalG=0;s.SubTotalS=0}else{s.SubTotalS=I;s.SubTotalG=0;s.SubTotal=0}}else{if(T==="0"||T===""){T="0"}this.getView().getModel("local").setProperty("/orderHeaderTemp/Deduction",T)}this.getView().byId("OrderReturn").getModel("returnModel").setProperty(i,s)}else{a[a.length-1].setText(y);if(n=="idsalesws"){a[a.length-1].setText(v);if(f){a[a.length-3].setText(0);a[a.length-2].setText(0)}else{a[a.length-3].setText(I);a[a.length-2].setText(0);a[a.length-1].setText(0)}}else{if(T==="0"||T===""){T="0"}this.getView().getModel("local").setProperty("/orderHeaderTemp/Deduction",T)}}}else if(s.Key==="CASH"){var y=this.getIndianCurr(s.Bhav);var S=parseFloat(s.Bhav).toFixed(0);S=this.getIndianCurr(S);if(this.deduction!=""){if(s.SubTotal&&s.SubTotal!=""){var M=u.parse(s.SubTotal);this.deduction=this.deduction+s.Bhav-M}else{this.deduction=this.deduction+s.Bhav}}else{this.deduction=s.Bhav}var C=this.deduction;var T=this.getIndianCurr(C);if(n=="idsalesws"){}else{if(T==="0"||T===""){T="0"}this.getView().getModel("local").setProperty("/orderHeaderTemp/Deduction",T)}if(i){s.SubTotal=y;if(n=="idsalesws"){s.SubTotal=S}this.getView().byId("OrderReturn").getModel("returnModel").setProperty(i,s)}else{a[a.length-1].setText(y);if(n=="idsalesws"){a[a.length-1].setText(S)}}}},onRetItemValidation:function(){var e=this;var t=this.getView().getId().split("---")[1];var r=this.getView().getModel("returnModel").getProperty("/TransData");var s=e.getView().byId("OrderReturn");var i=s.getBinding("rows");var a=false;for(var o=0;o<i.getLength();o++){var l=i.oList[o];if(l.Key!==""){if(l.Key==="CASH"){if(l.Bhav===""||l.Bhav===0||l.Bhav==="0"){this.getView().setBusy(false);s.getRows()[o].getCells()[5].setValueState("Error");a=true}else{s.getRows()[o].getCells()[1].setValueState("None");this.getView().setBusy(false)}}else{if(l.Weight===""||l.Weight===0||l.Weight==="0"){this.getView().setBusy(false);s.getRows()[o].getCells()[1].setValueState("Error");a=true}else{r.Weight=l.Weight;s.getRows()[o].getCells()[1].setValueState("None");this.getView().setBusy(false)}if(l.Bhav===""||l.Bhav===0||l.Bhav==="0"){if(t=="idsalesws"&&(l.Key==="OG"||l.Key==="OS")||t=="idsales"){this.getView().setBusy(false);s.getRows()[o].getCells()[5].setValueState("Error");a=true}}else{r.Bhav=l.Bhav;s.getRows()[o].getCells()[5].setValueState("None");this.getView().setBusy(false)}if(l.Tunch===""||l.Tunch===0||l.Tunch==="0"){if((l.Key==="KG"||l.Key==="KS")&&t=="idsales"){this.getView().setBusy(false);s.getRows()[o].getCells()[3].setValueState("Error");a=true}else{r.Tunch=l.Tunch;s.getRows()[o].getCells()[3].setValueState("None");this.getView().setBusy(false)}if(t=="idsalesws"){this.getView().setBusy(false);s.getRows()[o].getCells()[3].setValueState("Error");a=true}}this.getView().getModel("returnModel").setProperty("/TransData",r)}}}return a},orderItem:function(e,t){this.setVisible(e,t);var r=new sap.ui.model.json.JSONModel;var s=[];for(var i=1;i<=20;i++){var a={OrderNo:"",itemNo:"",Material:"",MaterialCode:"",Description:"",Qty:"0",QtyD:"0",Weight:"0",WeightD:"0",Making:"0",MakingD:"0",Tunch:0,Remarks:"",SubTotal:"",SubTotalS:0,SubTotalG:0,Category:"",CreatedBy:"",CreatedOn:"",ChangedBy:"",ChangedOn:""};s.push(a)}r.setData({itemData:s});this.setModel(r,"orderItems")},materialPopupOrderItem:function(e,t){this.setVisible(e,t);var r=new sap.ui.model.json.JSONModel;var s=[];for(var i=1;i<=20;i++){var a={id:"",OrderNo:"",itemNo:"",MaterialCode:"",Description:"",Qty:"0",Date:""};s.push(a)}r.setData({popupItemsData:s});this.setModel(r,"materialPopupOrderItems")},hideDColumns:function(e){var t=this.getView().getModel("VisibleSet");if(t.getProperty("/set")===true){t.setProperty("/set",false)}else{t.setProperty("/set",true)}},onCustomerSelect:function(t,r,s){var i=this;if(t.getParameter("selectedItem")){var a=t.getParameter("selectedItem").getBindingContext().getObject();this.setCustomerIdAndCustomerName(a)}e.sap.delayedCall(100,this,function(){this.getView().byId("idCash").focus();this.getView().byId("idCash").$().find("input").select()});this.getView().byId(t.getSource().getId().replace("customerId","idCustomerNameForSale")).setVisible(t.getParameter("selectedItem").getText()==="SALE").getFields()[0].setValue();this.getView().byId(t.getSource().getId().replace("customerId","idCustomerCityForSale")).setVisible(t.getParameter("selectedItem").getText()==="SALE").getFields()[0].setValue()},onBookingCustomerSelect:function(e,t,r){var s=this;if(e.getParameter("selectedItem")){var i=e.getParameter("selectedItem").getBindingContext().getObject();this.setCustomerIdAndCustomerName(i)}},getCustomer:function(e){var t=this;var r=e.getSource();if(e.getParameter("value")){var s=e.getParameter("value").toLocaleUpperCase();var i=new g("CustomerCode",u.EQ,s);this.getView().setBusy(true);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Customers","GET",{filters:[i]},{},this).then(function(e){if(e.results.length>0){var r=e.results[0];t.setCustomerIdAndCustomerName(r)}t.getView().setBusy(false)}).catch(function(e){})}},setCustomerIdAndCustomerName:function(e){this.getView().getModel("local").setProperty("/selectedCustomer",e);var t=this;var r=e.City;var s=e.CustomerCode;var i=e.Name;var a=this.getView().byId("Sales--customerId");var o=this.getView().byId("idCust");var l=this.getView().byId("idCustomerCode");var n=this.getView().byId("WSHeaderFragment--customerId");var d=this.getView().byId("idCoCustomer");var g=this.getView().byId("idCustNo");if(d){this.getView().byId("idCoCustomer").setValue(s);this.getView().getModel("local").setProperty("/customerOrder/Customer",this.allMasterData.customersId[s].id);this.getView().getModel("local").setProperty("/coTemp/CustomerCode",s);var u=new sap.ui.model.Filter("Customer","EQ","'"+this.allMasterData.customersId[s].id+"'");this.getView().byId("idCoTable").getBinding("items").filter(u)}else if(n){this.getView().byId("WSHeaderFragment--customerId").setValue(s);this.getView().getModel("local").setProperty("/WSOrderHeader/Customer",e.id);this.getView().getModel("local").setProperty("/orderHeaderTemp/CustomerId",s);this.getView().getModel("local").setProperty("/orderHeaderTemp/CustomerName",i)}else if(l){this.getView().byId("idCustomerCode").setValue(s);this.getView().getModel("local").setProperty("/BookingDetail/Customer",e.id);this.getView().getModel("local").setProperty("/BookingDetail/CustomerId",s);this.getView().getModel("local").setProperty("/BookingDetail/CustomerName",i);var p=this.getView().getModel("local").getProperty("/BookingDetail");if(this.getView().byId("idRb1").getSelected()){p.Type="Silver"}else{p.Type="Gold"}if(p.Customer===""){var c=new sap.ui.model.Filter("Type","EQ",p.Type);this.getView().byId("idTable").getBinding("items").filter(c);this.getView().byId("idTable1").getBinding("items").filter(c);this.getView().byId("idTable2").getBinding("items").filter(c);this.getView().byId("idBookingDlvTable").getBinding("items").filter(c)}else{var h=new sap.ui.model.Filter("Customer","EQ","'"+p.Customer.split("'")+"'");var c=new sap.ui.model.Filter("Type","EQ",p.Type);var u=new sap.ui.model.Filter({filters:[h,c],and:true});this.getView().byId("idTable").getBinding("items").filter([u]);this.getView().byId("idTable1").getBinding("items").filter([u]);this.getView().byId("idTable2").getBinding("items").filter([u]);this.getView().byId("idBookingDlvTable").getBinding("items").filter([u])}var t=this;$.post("/getTotalBookingCustomer",{myData:p}).then(function(e){console.log(e);if(p.Type="Silver"){t.byId("idBTQ").setText(parseFloat(e.BookedQtyTotal.toFixed(3)))}else{t.byId("idBTQ").setText(parseFloat(e.BookedQtyTotal.toFixed(2)))}t.byId("idBTQ").getText();parseFloat(t.byId("idBTQ").getText());if(parseFloat(t.byId("idBTQ").getText())>0){t.byId("idBTQ").setState("Success")}else{t.byId("idBTQ").setState("Warning")}t.byId("idBAP").setText(parseFloat(e.BookedAvgPriceTotal.toFixed(0)));t.byId("idBAP").getText();parseFloat(t.byId("idBAP").getText());if(parseFloat(t.byId("idBAP").getText())>0){t.byId("idBAP").setState("Success")}else{t.byId("idBAP").setState("Warning")}});var m=t;$.post("/getTotalDeliveredCustomer",{myData:p}).then(function(e){console.log(e);if(p.Type="Silver"){m.byId("idDTQ").setText(parseFloat(e.DeliveredQtyTotal.toFixed(3)))}else{m.byId("idDTQ").setText(parseFloat(e.DeliveredQtyTotal.toFixed(2)))}m.byId("idDTQ").getText();if(parseFloat(t.byId("idDTQ").getText())>0){m.byId("idDTQ").setState("Success")}else{m.byId("idDTQ").setState("Warning")}m.byId("idDAP").setText(parseFloat(e.DeliveredAvgPriceTotal.toFixed(0)));m.byId("idDAP").getText();if(parseFloat(t.byId("idDAP").getText())>0){m.byId("idDAP").setState("Success")}else{m.byId("idDAP").setState("Warning")}})}else if(o){this.getView().byId("idCust").setValue(s);this.getView().byId("idEntryDownload").setEnabled(true);this.getView().getModel("local").setProperty("/EntryData/Customer",e.id);this.getView().getModel("local").setProperty("/EntryData/CustomerCity",r);this.getView().getModel("local").setProperty("/entryHeaderTemp/customerId",s);this.getView().getModel("local").setProperty("/EntryData/customerName",i);var p=this.getView().getModel("local").getProperty("/EntryData");var u=new sap.ui.model.Filter("Customer","EQ","'"+p.Customer+"'");this.getView().byId("idTable").getBinding("items").filter(u);this.getView().byId("idTable1").getBinding("items").filter(u);this.getView().byId("idTable2").getBinding("items").filter(u);this.customerId=e.id;t.getView().byId("idCust").setVisible(true);$.post("/getTotalEntryCustomer",{Customer:p.Customer}).then(function(e){console.log(e);t.getView().byId("idCust").setVisible(true);if(e.CashTotal===null){t.byId("idTC").setText("0")}else{t.byId("idTC").setText(parseFloat(e.CashTotal.toFixed(2)))}t.byId("idTC").getText();parseFloat(t.byId("idTC").getText());if(parseFloat(t.byId("idTC").getText())>0){t.byId("idTC").setState("Success")}else{t.byId("idTC").setState("Warning")}t.getView().byId("idG").setText(parseFloat(e.GoldTotal.toFixed(3)));t.byId("idG").getText();parseFloat(t.byId("idG").getText());if(parseFloat(t.byId("idG").getText())>0){t.byId("idG").setState("Success")}else{t.byId("idG").setState("Warning")}t.getView().byId("idS").setText(parseFloat(e.SilverTotal.toFixed(2)));t.byId("idS").getText();parseFloat(t.byId("idS").getText());parseFloat(t.byId("idS").getText()).toFixed(3);if(parseFloat(parseFloat(t.byId("idS").getText()).toFixed(3))>0){t.byId("idS").setState("Success")}else{t.byId("idS").setState("Warning")}t.getView().byId("idCust").setVisible(true)})}else if(g){if(s){var f=this.getView().getModel("local").getProperty("/kachhiHeaderTemp");f.CustomerId=s;f.CustomerName=i;this.getView().getModel("local").setProperty("/kachhiHeaderTemp",f)}var p=this.getView().getModel("local").getProperty("/kacchiData");p.Customer=e.id;this.customerId=p.Customer;this.getView().getModel("local").setProperty("/kacchiData",p);this.getView().byId("idCustNo").setValue(s);this.getView().getModel("local").setProperty("/kacchiData/Customer",e.id);this.getView().getModel("local").setProperty("/kachhiHeaderTemp/customerId",s);var u=new sap.ui.model.Filter("Customer","EQ","'"+p.Customer+"'");this.getCustDataFromDB(u)}else{this.getView().byId("Sales--customerId").setValue(s);this.getView().getModel("local").setProperty("/orderHeader/Customer",e.id);this.getView().getModel("local").setProperty("/orderHeaderTemp/CustomerId",s)}},onMaterialSelect:function(e){var t=this;var r=e.getSource().getId().split("---")[1];if(r!==undefined){if(r.split("--")[0]==="idsales"){this.byId("Sales--idSaveIcon").setColor("red")}}var s=sap.ui.core.Fragment.byId("fr1","idSaveIndicator");if(s){s.setColor("red")}var i=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath());var a=e.getSource().getParent().getBindingContext("orderItems");var o=null;var l=this.getView().getModel("local").getProperty("/orderHeader");if(!a){a=e.getSource().getParent().getBindingContext("materialPopupOrderItems");o=l.id;var n=e.getSource().mBindingInfos.value.binding.oContext.sPath;if(!o){var d=new sap.ui.model.Filter("OrderNo","EQ",l.OrderNo);t.ODataHelper.callOData(t.getOwnerComponent().getModel(),"/OrderHeaders","GET",{filters:[d]},{},t).then(function(e){o=e.results[e.results.length-1].id;n=n+"/OrderNo";t.getView().getModel("materialPopupOrderItems").setProperty(n,o)})}else{n=n+"/OrderNo";t.getView().getModel("materialPopupOrderItems").setProperty(n,o)}}var g=a.getModel();var u=e.getSource().getParent().getBindingContext("orderItems");if(!u){u=e.getSource().getParent().getBindingContext("materialPopupOrderItems")}var p=u.getPath();g.setProperty(p+"/Material",i.id);if(i.HindiName){g.setProperty(p+"/Description",i.HindiName)}else{g.setProperty(p+"/Description",i.ProductName)}if(i.Making){g.setProperty(p+"/Making",i.CustomerMaking?i.CustomerMaking:i.Making)}else{g.setProperty(p+"/Making",0)}if(i.PricePerUnit){g.setProperty(p+"/MakingD",i.PricePerUnit)}else{g.setProperty(p+"/MakingD",0)}g.setProperty(p+"/Category",i.Category);g.setProperty(p+"/Type",i.Type);g.setProperty(p+"/Karat",i.Karat);if(i.Tunch){g.setProperty(p+"/Tunch",i.CustomerTunch?i.CustomerTunch:i.Tunch)}else{g.setProperty(p+"/Tunch",0)}var c=e.getSource().getId();if(c.includes("fr1")){t.focusAndSelectNextInput(c,"input[id*='fr1--id']")}else{t.focusAndSelectNextInput(c,"input[id*='---idsales--']")}},onTableExpand:function(e){var t=this.getView().oParent.oParent;var r=t.getMode();if(r=="ShowHideMode"){t.setMode(sap.m.SplitAppMode.HideMode)}else{t.setMode(sap.m.SplitAppMode.ShowHideMode)}},orderCustomCalculations:function(){var e=this;e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/CustomCalculations","GET",{},{},this).then(function(t){e.getView().getModel("local").setProperty("/CustomCalculations",t);e.getView().getModel("local").setProperty("/orderHeader/GoldBhav22",t.results[0].Second);e.getView().getModel("local").setProperty("/orderHeader/GoldBhav20",t.results[0].First);e.getView().getModel("local").setProperty("/orderHeader/GoldBhav",t.results[0].Gold);e.getView().getModel("local").setProperty("/orderHeader/SilverBhav",t.results[0].Silver)}).catch(function(t){e.getView().getModel("local").setProperty("/orderHeader/GoldBhav22",0);e.getView().getModel("local").setProperty("/orderHeader/GoldBhav20",0);e.getView().getModel("local").setProperty("/orderHeader/GoldBhav",0);e.getView().getModel("local").setProperty("/orderHeader/SilverBhav",0)})},onSuggest:function(e){var t=e.getParameter("suggestValue").toLocaleUpperCase();var r=[];if(t){r.push(new g("CustomerCode",u.Contains,t));r.push(new g("Name",u.Contains,t));e.getSource().getBinding("suggestionItems").filter(new g({filters:r,and:false}));e.getSource().getBinding("suggestionItems").refresh(true);e.getSource().getBinding("suggestionItems").isSuspended();e.getSource().getBinding("suggestionItems").resume();var s=new sap.ui.model.Sorter({path:"CustomerCode",descending:false});e.getSource().getBinding("suggestionItems").sort(s)}},handleNavButtonPress:function(){var e=this.getView().getParent().getParent();var t=e.getMasterPages()[0];e.toMaster(t,"flip")},orderReturn:function(e,t){this.setVisible(e,t);var r=new sap.ui.model.json.JSONModel;var s=[];for(var i=1;i<=5;i++){var a={Type:"",Key:"",ReturnId:"",Weight:0,KWeight:0,Tunch:0,Qty:0,Bhav:0,Remarks:"",SubTotalS:0,SubTotalG:0,SubTotal:"",CreatedBy:"",CreatedOn:"",ChangedBy:"",ChangedOn:""};s.push(a)}r.setData({TransData:s});this.setModel(r,"returnModel")}})});